<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙ…Ø±ÛŒÙ†ÛŒ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Vazirmatn & Roboto for Material -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- html2pdf.js for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* General Styles - Base for all themes */
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #111827; /* Default theme background */
            color: #e5e7eb; /* Default theme text */
            overscroll-behavior: none;
        }
        .hidden { display: none; }
        .modal-overlay {
            position: fixed;
            z-index: 50;
            transition: opacity 0.3s, visibility 0.3s;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #1f2937; /* Default modal bg */
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-overlay:not(.hidden) .modal-content {
            transform: scale(1);
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-open {
            transform: translateX(0) !important;
        }
    </style>
    
    <!-- Dynamic Theme Styles will be injected here -->
    <style id="theme-styles">
        /* THEME-SPECIFIC CSS WILL BE POPULATED HERE BY JAVASCRIPT */
    </style>
</head>
<body class="antialiased">

    <div id="app-container"></div>

    <!-- Login View (Theme independent) -->
    <div id="login-view" class="hidden">
         <div class="min-h-screen flex items-center justify-center p-4" style="background-color: #111827;">
            <div class="w-full max-w-sm p-8 rounded-2xl" style="background-color: #1f2937; border: 1px solid #374151;">
                <h2 class="text-2xl font-bold text-center mb-6" style="background: linear-gradient(to right, #a855f7, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block mb-2 text-sm font-medium text-gray-400">Ø§ÛŒÙ…ÛŒÙ„</label>
                        <input type="email" id="login-email" class="w-full p-3 rounded-lg" style="background-color: #374151; border: 1px solid #4b5563; color: #e5e7eb;" required>
                    </div>
                    <div class="mb-6 relative">
                        <label for="password" class="block mb-2 text-sm font-medium text-gray-400">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                        <input type="password" id="login-password" class="w-full p-3 rounded-lg pl-10" style="background-color: #374151; border: 1px solid #4b5563; color: #e5e7eb;" required>
                        <span id="toggle-password" class="absolute left-3 top-10 cursor-pointer text-gray-400">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    <button type="submit" id="login-btn" class="w-full p-3 rounded-lg font-semibold text-white transition-all" style="background-color: #4f46e5;">ÙˆØ±ÙˆØ¯</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- All Modals (Styling will be overridden by theme CSS) -->
    <div id="share-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡</h3>
            <p class="text-gray-400 mb-4">Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø«Ø§Ø¨Øª Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ø±Ø§ÛŒ Ø´Ø§Ú¯Ø±Ø¯ Ø®ÙˆØ¯ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.</p>
            <div class="flex items-center gap-2">
                <input type="text" id="share-link-input" readonly class="input-field text-left" dir="ltr">
                <button id="copy-link-btn" class="btn btn-primary px-4"><i class="fas fa-copy"></i></button>
            </div>
            <button id="close-modal-btn" class="btn btn-secondary w-full mt-6">Ø¨Ø³ØªÙ†</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <p id="confirm-modal-text" class="text-lg mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-yes" class="btn btn-danger">Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†</button>
                <button id="confirm-modal-no" class="btn btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
            </div>
        </div>
    </div>
    
    <div id="settings-modal" class="modal-overlay hidden">
         <div class="modal-content">
            <h3 class="text-xl font-bold mb-6">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h3>
            <div class="mb-4">
                <label class="block mb-3 font-semibold text-gray-300">Ø§Ù†ØªØ®Ø§Ø¨ ØªÙ… Ù¾Ù†Ù„</label>
                <select id="admin-theme-selector" class="input-field w-full">
                    <option value="theme-default">Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (ØªÛŒØ±Ù‡)</option>
                    <option value="theme-material">Ù…ØªØ±ÛŒØ§Ù„ Ø¯ÛŒØ²Ø§ÛŒÙ†</option>
                    <option value="theme-minimal">Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„</option>
                    <option value="theme-apple">Ø§Ù¾Ù„ (Cupertino)</option>
                    <option value="theme-neobrutalism">Ù†Ø¦ÙˆØ¨Ø±ÙˆØªØ§Ù„ÛŒØ³Ù…</option>
                    <option value="theme-gaming">Ú¯ÛŒÙ…ÛŒÙ†Ú¯</option>
                </select>
            </div>
            <p class="text-sm text-gray-400 mb-6">Ø§ÛŒÙ† ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙÙ‚Ø· Ø±ÙˆÛŒ Ø¸Ø§Ù‡Ø± Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ù…Ø§ ØªØ§Ø«ÛŒØ± Ø¯Ø§Ø±Ø¯ Ùˆ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
            <button id="close-settings-modal-btn" class="btn btn-primary w-full">Ø¨Ø³ØªÙ†</button>
        </div>
    </div>


    <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, addDoc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- PASTE YOUR FIREBASE CONFIG HERE ---
    const firebaseConfig = {
      apiKey: "AIzaSyCpqIxjnZ_4vlc6qRJRmVuQzh3wSnZHxUM",
      authDomain: "baran-fit.firebaseapp.com",
      projectId: "baran-fit",
      storageBucket: "baran-fit.appspot.com",
      messagingSenderId: "691141349991",
      appId: "1:691141349991:web:6f232056722d5bd6fe7ac2",
      measurementId: "G-3SBLNFQSNK"
    };
    
    const ADMIN_EMAIL = "mail@baranfit.ir";

    let db, auth;
    try {
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch (e) {
        console.error("Error initializing Firebase:", e);
        document.getElementById('app-container').innerHTML = `<div class="h-screen flex items-center justify-center text-center"><div><h1 class="text-2xl font-bold text-red-500 mb-4">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡</h1></div></div>`;
    }
    
    // --- THEME DEFINITIONS ---
    const themes = {
        'theme-default': `
            body { background-color: #111827; color: #e5e7eb; font-family: 'Vazirmatn', sans-serif; }
            .main-gradient-text { background: linear-gradient(to right, #a855f7, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
            .card, .modal-content { background-color: #1f2937; border: 1px solid #374151; border-radius: 1rem; }
            .input-field { background-color: #374151; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; width: 100%; color: #e5e7eb; transition: border-color 0.2s; }
            .input-field:focus { outline: none; border-color: #6366f1; }
            .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; text-align: center; display: inline-flex; align-items: center; justify-content: center; border: none; }
            .btn:disabled { cursor: not-allowed; opacity: 0.5; }
            .btn-primary { background-color: #4f46e5; color: white; } .btn-primary:hover:not(:disabled) { background-color: #4338ca; }
            .btn-secondary { background-color: #374151; color: #e5e7eb; } .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
            .btn-danger { background-color: #dc2626; color: white; } .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
            .btn-success { background-color: #16a34a; color: white; } .btn-success:hover:not(:disabled) { background-color: #15803d; }
            #sidebar { background-color: #1f2937; }
            #main-content { background-color: #111827; }
            .athlete-item:hover { background-color: #374151; }
            .athlete-item.active { background-color: #4f46e5; color: white; }
            .day-tab.active { background-color: #4f46e5; color: white; }
            .toast-container { background-color: #1f2937; color: white; border: 1px solid #374151; }
        `,
        'theme-material': `
            body { background-color: #f3f3ff; color: #1c1b1f; font-family: 'Roboto', sans-serif; }
            .main-gradient-text { color: #4a55b1; }
            .card, .modal-content { background-color: #feFBff; border: none; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
            .input-field { background-color: #eef0ff; border: none; border-bottom: 2px solid #79747e; border-radius: 4px 4px 0 0; padding: 1rem; width: 100%; color: #1c1b1f; transition: all 0.2s; }
            .input-field:focus { outline: none; border-bottom-color: #4a55b1; background-color: #e8e8f3; }
            .btn { padding: 0.625rem 1.5rem; border-radius: 20px; font-weight: 500; transition: all 0.2s ease; cursor: pointer; text-align: center; display: inline-flex; align-items: center; justify-content: center; border: 1px solid transparent; letter-spacing: 0.1px; text-transform: uppercase;}
            .btn:disabled { cursor: not-allowed; opacity: 0.5; }
            .btn-primary { background-color: #4a55b1; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); } .btn-primary:hover:not(:disabled) { background-color: #3f4a9a; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
            .btn-secondary { background-color: transparent; color: #4a55b1; border-color: #c7c7d4; } .btn-secondary:hover:not(:disabled) { background-color: #eef0ff; }
            .btn-danger { background-color: #b3261e; color: white; } .btn-danger:hover:not(:disabled) { background-color: #9a1f18; }
            .btn-success { background-color: #248428; color: white; } .btn-success:hover:not(:disabled) { background-color: #1d6a20; }
            #sidebar { background-color: #f7f7ff; border-left: 1px solid #e0e0e0; }
            #main-content { background-color: #f3f3ff; }
            .athlete-item:hover { background-color: #eef0ff; }
            .athlete-item.active { background-color: #4a55b1; color: white; }
            .day-tab.active { background-color: #dbeffc; color: #001e2f; border-bottom: 2px solid #4a55b1; border-radius: 4px 4px 0 0; }
            .toast-container { background-color: #313033; color: #f4eff4; }
        `,
        'theme-minimal': `
            body { background-color: #ffffff; color: #111111; font-family: 'Vazirmatn', sans-serif; font-weight: 400; }
            .main-gradient-text { color: #000; }
            .card, .modal-content { background-color: #ffffff; border: 1px solid #e5e5e5; border-radius: 0; }
            .input-field { background-color: #ffffff; border: 1px solid #d1d1d1; border-radius: 4px; padding: 0.75rem; width: 100%; color: #111111; }
            .input-field:focus { outline: none; border-color: #000; }
            .btn { padding: 0.75rem 1.5rem; border-radius: 4px; font-weight: 500; transition: all 0.2s; cursor: pointer; text-align: center; display: inline-flex; align-items: center; justify-content: center; border: 1px solid #000; }
            .btn:disabled { cursor: not-allowed; background-color: #f5f5f5; color: #aaa; border-color: #ddd; }
            .btn-primary { background-color: #000; color: #fff; } .btn-primary:hover:not(:disabled) { background-color: #333; }
            .btn-secondary { background-color: #fff; color: #000; } .btn-secondary:hover:not(:disabled) { background-color: #f7f7f7; }
            .btn-danger { background-color: transparent; color: #d90000; border-color: #d90000; } .btn-danger:hover:not(:disabled) { background-color: #d90000; color: #fff; }
            .btn-success { background-color: #007d25; color: #fff; border-color: #007d25; } .btn-success:hover:not(:disabled) { background-color: #005f1d; }
            #sidebar { background-color: #fafafa; border-left: 1px solid #e5e5e5; }
            #main-content { background-color: #ffffff; }
            .athlete-item:hover { background-color: #f5f5f5; }
            .athlete-item.active { background-color: #000; color: #fff; }
            .day-tab { border-radius: 0; }
            .day-tab.active { background-color: transparent; border-bottom: 2px solid #000; }
            .toast-container { background-color: #111; color: #fff; border: none; }
        `,
        'theme-apple': `
            body { background-color: #f5f5f7; color: #1d1d1f; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; }
            .main-gradient-text { color: #007aff; }
            .card, .modal-content { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
            .input-field { background-color: #e8e8ed; border: none; border-radius: 8px; padding: 0.8rem; width: 100%; color: #1d1d1f; }
            .input-field:focus { outline: none; box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.5); }
            .btn { padding: 0.65rem 1.25rem; border-radius: 8px; font-weight: 500; transition: all 0.2s; cursor: pointer; text-align: center; display: inline-flex; align-items: center; justify-content: center; border: none; }
            .btn:disabled { cursor: not-allowed; opacity: 0.6; }
            .btn-primary { background-color: #007aff; color: white; } .btn-primary:hover:not(:disabled) { background-color: #006ee6; }
            .btn-secondary { background-color: #e8e8ed; color: #1d1d1f; } .btn-secondary:hover:not(:disabled) { background-color: #dddde2; }
            .btn-danger { background-color: #ff3b30; color: white; } .btn-danger:hover:not(:disabled) { background-color: #ff2112; }
            .btn-success { background-color: #34c759; color: white; } .btn-success:hover:not(:disabled) { background-color: #2fb34f; }
            #sidebar { background-color: rgba(240, 240, 245, 0.9); backdrop-filter: blur(20px); border-left: 1px solid rgba(0,0,0,0.1); }
            #main-content { background-color: #f5f5f7; }
            .athlete-item { border-radius: 8px; }
            .athlete-item:hover { background-color: #e8e8ed; }
            .athlete-item.active { background-color: #007aff; color: white; }
            .day-tab { border-radius: 8px; }
            .day-tab.active { background-color: #007aff; color: white; }
            .toast-container { background-color: rgba(40,40,40,0.8); backdrop-filter: blur(10px); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        `,
        'theme-neobrutalism': `
            body { background-color: #f5f5f5; color: #000000; font-family: 'Vazirmatn', sans-serif; font-weight: 500; }
            .main-gradient-text { color: #000; }
            .card, .modal-content, .input-field, .btn { border: 2px solid #000; border-radius: 6px; box-shadow: 4px 4px 0 #000; }
            .card, .modal-content { background-color: #fff; }
            .input-field { background-color: #fff; padding: 0.75rem; width: 100%; color: #000; }
            .input-field:focus { outline: none; border-color: #ff8a00; box-shadow: 4px 4px 0 #ff8a00; }
            .btn { padding: 0.75rem 1.5rem; font-weight: 700; transition: all 0.1s ease-out; cursor: pointer; text-align: center; display: inline-flex; align-items: center; justify-content: center; }
            .btn:hover:not(:disabled) { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }
            .btn:active:not(:disabled) { transform: translate(4px, 4px); box-shadow: 0px 0px 0 #000; }
            .btn:disabled { cursor: not-allowed; opacity: 0.7; background-color: #ccc; color: #888; box-shadow: none; transform: none; }
            .btn-primary { background-color: #a259ff; color: #000; }
            .btn-secondary { background-color: #fff; color: #000; }
            .btn-danger { background-color: #ff5252; color: #000; }
            .btn-success { background-color: #00c853; color: #000; }
            #sidebar { background-color: #fff8e1; }
            #main-content { background-color: #f5f5f5; }
            .athlete-item.active { background-color: #fffde7; border-color: #0d47a1; color: #0d47a1; }
            .day-tab.active { background-color: #ff8a00; color: #000; }
            .toast-container { border: 2px solid #000; box-shadow: 4px 4px 0 #000; background-color: #fff; color: #000;}
        `,
        'theme-gaming': `
            body { background-color: #1a1a2e; color: #e0e0e0; font-family: 'Vazirmatn', sans-serif; }
            .main-gradient-text { color: #00f5d4; text-shadow: 0 0 5px #00f5d4, 0 0 10px #00f5d4; }
            .card, .modal-content { background: rgba(27, 27, 42, 0.8); border: 1px solid #5a5a8a; border-radius: 0; clip-path: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%); }
            .input-field { background: #16213e; border: 1px solid #5a5a8a; border-radius: 2px; padding: 0.75rem; width: 100%; color: #e0e0e0; caret-color: #00f5d4; }
            .input-field:focus { outline: none; border-color: #00f5d4; box-shadow: 0 0 10px rgba(0, 245, 212, 0.5); }
            .btn { padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer; text-align: center; display: inline-flex; align-items: center; justify-content: center; border: 1px solid #00f5d4; color: #00f5d4; background: transparent; transition: all 0.2s; }
            .btn:hover:not(:disabled) { background: #00f5d4; color: #1a1a2e; box-shadow: 0 0 15px #00f5d4; }
            .btn:disabled { cursor: not-allowed; opacity: 0.4; border-color: #5a5a8a; color: #5a5a8a; }
            .btn-primary { border-color: #00f5d4; color: #00f5d4; } .btn-primary:hover:not(:disabled) { background: #00f5d4; color: #1a1a2e; }
            .btn-secondary { border-color: #5a5a8a; color: #e0e0e0; } .btn-secondary:hover:not(:disabled) { background: #5a5a8a; color: #fff; }
            .btn-danger { border-color: #e94560; color: #e94560; } .btn-danger:hover:not(:disabled) { background: #e94560; color: #1a1a2e; }
            .btn-success { border-color: #2de292; color: #2de292; } .btn-success:hover:not(:disabled) { background: #2de292; color: #1a1a2e; }
            #sidebar { background-color: #16213e; }
            #main-content { background-color: #1a1a2e; }
            .athlete-item:hover { background-color: rgba(0, 245, 212, 0.1); }
            .athlete-item.active { background: #00f5d4; color: #1a1a2e; }
            .day-tab.active { background: transparent; border-bottom: 2px solid #00f5d4; color: #00f5d4; }
            .toast-container { background: #16213e; color: #00f5d4; border: 1px solid #00f5d4; text-shadow: 0 0 5px #00f5d4;}
        `
    };

    function applyTheme(themeName = 'theme-default') {
        const styleSheet = document.getElementById('theme-styles');
        const body = document.body;
        
        body.className = body.className.replace(/theme-\S+/g, '').trim();
        body.classList.add(themeName);
        styleSheet.innerHTML = themes[themeName] || themes['theme-default'];
    }

    function saveAdminTheme(themeName) {
        localStorage.setItem('adminTheme', themeName);
    }

    function loadAdminTheme() {
        return localStorage.getItem('adminTheme') || 'theme-default';
    }


    const appContainer = document.getElementById('app-container');
    const loginView = document.getElementById('login-view');
    let athletes = []; 
    let currentAthleteId = null;
    
    function showToast(message, duration = 3000) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), duration);
    }

    function showConfirm(text, onConfirm) {
        const modal = document.getElementById('confirm-modal');
        document.getElementById('confirm-modal-text').textContent = text;
        modal.classList.remove('hidden');

        const yesBtn = document.getElementById('confirm-modal-yes');
        const noBtn = document.getElementById('confirm-modal-no');

        const cleanup = () => {
            modal.classList.add('hidden');
            yesBtn.replaceWith(yesBtn.cloneNode(true));
            noBtn.replaceWith(noBtn.cloneNode(true));
        };

        const yesHandler = () => { onConfirm(); cleanup(); };
        const noHandler = () => cleanup();

        document.getElementById('confirm-modal-yes').addEventListener('click', yesHandler, { once: true });
        document.getElementById('confirm-modal-no').addEventListener('click', noHandler, { once: true });
    }

    function renderLoginView() {
        appContainer.innerHTML = '';
        loginView.classList.remove('hidden');
        document.body.className = ''; // Reset theme for login page
        
        const loginForm = document.getElementById('login-form');
        loginForm.onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const loginBtn = document.getElementById('login-btn');
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showToast("Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.");
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'ÙˆØ±ÙˆØ¯';
            }
        };

        const togglePassword = document.getElementById('toggle-password');
        togglePassword.onclick = () => {
            const passwordInput = document.getElementById('login-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            togglePassword.querySelector('i').classList.toggle('fa-eye');
            togglePassword.querySelector('i').classList.toggle('fa-eye-slash');
        };
    }

    async function handlePublicView(athleteId) {
        appContainer.innerHTML = `<div class="h-screen flex items-center justify-center text-center"><p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡...</p></div>`;
        try {
            const athleteRef = doc(db, "athletes", athleteId);
            const docSnap = await getDoc(athleteRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                const publicTheme = data.plan?.theme || 'theme-default';
                applyTheme(publicTheme);
                const planData = { ...data.plan, athleteName: data.name };
                renderUserView(planData);
            } else {
                applyTheme('theme-default');
                appContainer.innerHTML = `<div class="h-screen flex items-center justify-center text-center"><h1 class="text-2xl font-bold text-red-500">Ø¨Ø±Ù†Ø§Ù…Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯</h1></div>`;
            }
        } catch (error) {
            applyTheme('theme-default');
            console.error("Error fetching public plan:", error);
            appContainer.innerHTML = `<div class="h-screen flex items-center justify-center text-center"><h1 class="text-2xl font-bold text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</h1></div>`;
        }
    }
    
    function renderUserView(data) {
        const { trainerName, athleteName, startDate, endDate, trainerPhone, instructions, workoutDays, importantNotes } = data;
        
        loginView.classList.add('hidden');

        appContainer.innerHTML = `
            <div id="workout-plan-content" class="container mx-auto p-4 md:p-8 max-w-4xl">
                <header class="text-center mb-4">
                    <h1 class="text-3xl md:text-4xl font-bold mb-2">Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙ…Ø±ÛŒÙ†ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ</h1>
                    <h2 class="text-2xl md:text-3xl font-bold main-gradient-text">${trainerName || 'Ø¨Ø§Ø±Ø§Ù† Ø­ÛŒØ¯Ø±ÛŒ'}</h2>
                </header>

                <div id="pdf-controls" class="my-6 text-center">
                    <button id="pdf-download-btn" class="btn btn-primary">
                        <i class="fas fa-file-pdf mr-2"></i>
                        Ø¯Ø±ÛŒØ§ÙØª PDF
                    </button>
                </div>

                <div class="card p-6 mb-8 text-center shadow-lg">
                    <h3 class="text-xl font-bold mb-4">ÙˆØ±Ø²Ø´Ú©Ø§Ø±: <span class="main-gradient-text">${athleteName}</span></h3>
                    <div class="flex flex-col md:flex-row justify-center items-center gap-4 md:gap-8 opacity-80">
                        <div class="flex items-center gap-2"><i class="fas fa-play-circle"></i><span>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹: ${startDate}</span></div>
                        <div class="flex items-center gap-2"><i class="fas fa-stop-circle"></i><span>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†: ${endDate}</span></div>
                        <div class="flex items-center gap-2"><i class="fas fa-phone-alt"></i><span>Ø´Ù…Ø§Ø±Ù‡ Ù…Ø±Ø¨ÛŒ: <a href="tel:${trainerPhone}" class="hover:underline">${trainerPhone}</a></span></div>
                    </div>
                </div>
                <div class="card p-6 mb-8 shadow-lg">
                    <h3 class="text-xl font-bold mb-6 text-center">Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙ…Ø±ÛŒÙ†ÛŒ Ø´Ù…Ø§</h3>
                    <div id="user-tabs-container" class="flex justify-center items-center gap-2 md:gap-4 mb-6 p-2 rounded-full overflow-x-auto"></div>
                    <div id="user-workout-days-content"></div>
                </div>
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                     <div class="card p-6 shadow-lg"><h3 class="text-lg font-bold mb-3"><i class="fas fa-clipboard-list mr-2"></i>Ù†Ú©Ø§Øª Ùˆ Ø¯Ø³ØªÙˆØ±â€ŒØ§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§</h3><ul class="space-y-3">${(instructions || []).map(item => `<li>${item}</li>`).join('')}</ul></div>
                     <div class="card p-6 shadow-lg"><h3 class="text-lg font-bold mb-3"><i class="fas fa-exclamation-triangle mr-2"></i>Ù†Ú©Ø§Øª Ù…Ù‡Ù…</h3><ul class="space-y-3">${(importantNotes || []).map(item => `<li>${item}</li>`).join('')}</ul></div>
                </div>
                 <footer class="text-center mt-12 opacity-70">
                    <p>Ø¨Ø§Ø±Ø§Ù† Ø±Ùˆ Ù…ÛŒØªÙˆÙ†ÛŒ Ø§ÛŒÙ† Ø¬Ø§ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†ÛŒ <span class="text-lg">ğŸ¥ºâ¤ï¸</span></p>
                    <div class="flex justify-center gap-6 mt-4">
                        <a href="https://www.instagram.com/lifebarani" target="_blank" rel="noopener noreferrer" class="text-pink-400 hover:text-pink-300 text-3xl transition-transform transform hover:scale-110"><i class="fab fa-instagram"></i></a>
                        <a href="https://t.me/lifebarani" target="_blank" rel="noopener noreferrer" class="text-sky-400 hover:text-sky-300 text-3xl transition-transform transform hover:scale-110"><i class="fab fa-telegram"></i></a>
                    </div>
                </footer>
            </div>
        `;

        const tabsContainer = document.getElementById('user-tabs-container');
        const daysContentContainer = document.getElementById('user-workout-days-content');

        tabsContainer.innerHTML = (workoutDays || []).map((day, index) => `<button data-index="${index}" class="day-tab flex-shrink-0 px-4 py-2 text-sm font-semibold rounded-full transition-all">${day.day}</button>`).join('');
        
        daysContentContainer.innerHTML = (workoutDays || []).map((day, dayIndex) => {
            const exercisesHtml = (day.exercises || []).map((ex, i) => `
                <tr class="border-b">
                    <td class="p-3 text-center font-semibold">${i + 1}</td>
                    <td class="p-3 font-medium">${ex.name}</td>
                    <td class="p-3 text-center">${ex.sets}</td>
                    <td class="p-3">${ex.desc}</td>
                </tr>
            `).join('');

            return `
                <div id="day-view-${dayIndex}" class="day-view-content hidden space-y-4">
                    <h4 class="text-lg font-semibold mb-2 text-center md:hidden">${day.day}</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="border-b-2">
                                <tr>
                                    <th class="p-3 text-center">#</th>
                                    <th class="p-3">Ø­Ø±Ú©Øª</th>
                                    <th class="p-3 text-center">Ø³Øª</th>
                                    <th class="p-3">ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>${exercisesHtml}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }).join('');
        
        document.querySelectorAll('.day-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                const dayIndex = btn.dataset.index;
                document.querySelectorAll('.day-tab').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.day-view-content').forEach(c => c.classList.add('hidden'));
                
                btn.classList.add('active');
                document.getElementById(`day-view-${dayIndex}`)?.classList.remove('hidden');
            });
        });

        if ((workoutDays || []).length > 0) {
            document.querySelector('.day-tab')?.click();
        }

        document.getElementById('pdf-download-btn').addEventListener('click', () => generatePdf(athleteName));
    }

    function generatePdf(athleteName = 'ÙˆØ±Ø²Ø´Ú©Ø§Ø±') {
        const pdfControls = document.getElementById('pdf-controls');
        const tabsContainer = document.getElementById('user-tabs-container');
        const dayContentDivs = document.querySelectorAll('.day-view-content');
        const elementToPrint = document.getElementById('workout-plan-content');
        
        const activeTabIndex = document.querySelector('.day-tab.active')?.dataset.index || '0';

        showToast('Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„ PDF...');

        // --- Prepare for PDF Generation ---
        pdfControls.classList.add('hidden');
        tabsContainer.classList.add('hidden');
        dayContentDivs.forEach(div => {
            div.classList.remove('hidden');
            div.style.pageBreakInside = 'avoid';
            // Also remove the mobile-only day title for PDF view
            div.querySelector('h4')?.classList.add('hidden'); 
        });

        const opt = {
            margin:       [0.5, 0.5, 0.5, 0.5],
            filename:     `Ø¨Ø±Ù†Ø§Ù…Ù‡-ØªÙ…Ø±ÛŒÙ†ÛŒ-${athleteName}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true, logging: false },
            jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        setTimeout(() => {
            html2pdf().set(opt).from(elementToPrint).save().finally(() => {
                // --- Restore UI After PDF Generation ---
                pdfControls.classList.remove('hidden');
                tabsContainer.classList.remove('hidden');
                dayContentDivs.forEach((div, index) => {
                    if (index.toString() !== activeTabIndex) {
                        div.classList.add('hidden');
                    }
                    div.querySelector('h4')?.classList.remove('hidden');
                });
                
                showToast('ÙØ§ÛŒÙ„ PDF Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯.');
            });
        }, 100); // Small delay to allow DOM to update before capture
    }
    
    function renderAdminPanel() {
        loginView.classList.add('hidden');
        appContainer.innerHTML = `
            <div class="relative min-h-screen md:flex">
                <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-20 md:hidden hidden"></div>
                <aside id="sidebar" class="sidebar text-white w-64 fixed inset-y-0 right-0 z-30 transform translate-x-full md:relative md:translate-x-0 flex-shrink-0">
                    <div class="p-4 h-full flex flex-col">
                        <div class="text-center mb-8 flex-shrink-0"><h1 class="text-xl font-bold main-gradient-text">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø±Ø§Ù†</h1></div>
                        <h2 class="text-sm font-semibold text-gray-400 mb-2 uppercase flex-shrink-0">Ù„ÛŒØ³Øª Ø´Ø§Ú¯Ø±Ø¯Ø§Ù†</h2>
                        <div id="athlete-list" class="flex-grow overflow-y-auto space-y-2 pr-2"><p class="text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>
                        <button id="add-athlete-btn" class="btn btn-primary w-full mt-4 flex-shrink-0"><i class="fas fa-plus mr-2"></i>Ø§ÙØ²ÙˆØ¯Ù† Ø´Ø§Ú¯Ø±Ø¯</button>
                        <div class="flex items-center gap-2 mt-2 flex-shrink-0">
                           <button id="logout-btn" class="btn btn-danger w-full"><i class="fas fa-sign-out-alt mr-2"></i>Ø®Ø±ÙˆØ¬</button>
                           <button id="settings-btn" class="btn btn-secondary px-4"><i class="fas fa-cog"></i></button>
                        </div>
                    </div>
                </aside>
                <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto">
                    <div class="md:hidden flex justify-between items-center mb-4">
                        <h1 class="text-lg font-bold main-gradient-text">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h1>
                        <button id="menu-toggle-btn" class="text-2xl"><i class="fas fa-bars"></i></button>
                    </div>
                    <div id="welcome-screen" class="flex items-center justify-center h-full">
                        <div class="text-center text-gray-500"><i class="fas fa-users text-6xl mb-4"></i><h2 class="text-2xl font-bold">ÛŒÚ© Ø´Ø§Ú¯Ø±Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</h2></div>
                    </div>
                    <div id="editor-screen" class="hidden"></div>
                </main>
            </div>
        `;
        listenForAthletes();
        setupAdminEventListeners();
    }
    
    function renderAthleteList() {
        const athleteListContainer = document.getElementById('athlete-list');
        if(!athleteListContainer) return;
        if (athletes.length === 0) {
            athleteListContainer.innerHTML = `<p class="text-gray-500 text-center p-4">Ù‡Ù†ÙˆØ² Ø´Ø§Ú¯Ø±Ø¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡.</p>`;
            return;
        }
        athleteListContainer.innerHTML = athletes.map(athlete => `<div data-id="${athlete.id}" class="athlete-item p-3 rounded-lg cursor-pointer transition-colors ${athlete.id === currentAthleteId ? 'active' : ''}"><span class="font-semibold">${athlete.name}</span></div>`).join('');
        
        document.querySelectorAll('.athlete-item').forEach(item => {
            item.addEventListener('click', () => {
                loadAthleteEditor(item.dataset.id);
                document.getElementById('sidebar')?.classList.remove('sidebar-open');
                document.getElementById('sidebar-overlay')?.classList.add('hidden');
            });
        });
    }

    async function renderEditor(athlete, activeDayIndex = 0) {
        document.getElementById('welcome-screen').classList.add('hidden');
        const editorScreen = document.getElementById('editor-screen');
        editorScreen.classList.remove('hidden');

        const plan = athlete.plan || {};
        const workoutDays = plan.workoutDays || [];
        
        let tabsHtml = workoutDays.map((day, index) => `<button class="day-tab flex-shrink-0 px-4 py-2 rounded-md font-semibold transition-colors ${index === activeDayIndex ? 'active' : ''}" data-day="${index}">${day.day}</button>`).join('');

        let daysHtml = workoutDays.map((day, dayIndex) => {
            let exercises = day.exercises || [];
            let exercisesHtml = exercises.map((ex, exIndex) => `<tr class="exercise-row"><td class="p-2"><input type="text" class="input-field" value="${ex.name || ''}" data-day="${dayIndex}" data-ex="${exIndex}" data-field="name"></td><td class="p-2"><input type="text" class="input-field" value="${ex.sets || ''}" data-day="${dayIndex}" data-ex="${exIndex}" data-field="sets"></td><td class="p-2"><input type="text" class="input-field" value="${ex.desc || ''}" data-day="${dayIndex}" data-ex="${exIndex}" data-field="desc"></td><td class="p-2 text-center"><button class="btn btn-danger btn-sm px-3 py-1 remove-exercise-btn" data-day="${dayIndex}" data-ex="${exIndex}"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            return `<div id="day-content-${dayIndex}" class="day-content ${dayIndex === activeDayIndex ? '' : 'hidden'}"><div class="overflow-x-auto"><table class="w-full text-right min-w-[600px]"><thead><tr><th class="p-2 w-2/5">Ø­Ø±Ú©Øª</th><th class="p-2 w-1/5">Ø³Øª</th><th class="p-2 w-2/5">ØªÙˆØ¶ÛŒØ­Ø§Øª</th><th class="p-2">Ø­Ø°Ù</th></tr></thead><tbody>${exercisesHtml}</tbody></table></div><button class="btn btn-secondary mt-4 add-exercise-btn" data-day="${dayIndex}"><i class="fas fa-plus mr-2"></i>Ø§ÙØ²ÙˆØ¯Ù† Ø­Ø±Ú©Øª</button></div>`;
        }).join('');
        
        const themeOptions = Object.keys(themes).map(key => {
            const themeName = key.replace('theme-', '');
            return `<option value="${key}" ${plan.theme === key ? 'selected' : ''}>${themeName.charAt(0).toUpperCase() + themeName.slice(1)}</option>`;
        }).join('');

        editorScreen.innerHTML = `
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
                 <h2 class="text-2xl font-bold">Ø¨Ø±Ù†Ø§Ù…Ù‡: <input type="text" id="athlete-name-input" class="bg-transparent border-b-2 outline-none w-full sm:w-auto" value="${athlete.name || ''}"></h2>
                 <div class="flex gap-2 flex-wrap"><button id="share-btn" class="btn btn-success flex-grow sm:flex-grow-0"><i class="fas fa-share-alt mr-2"></i>Ø§Ø´ØªØ±Ø§Ú©</button><button id="save-all-btn" class="btn btn-primary flex-grow sm:flex-grow-0"><i class="fas fa-save mr-2"></i>Ø°Ø®ÛŒØ±Ù‡</button><button id="delete-athlete-btn" class="btn btn-danger flex-grow sm:flex-grow-0"><i class="fas fa-user-times mr-2"></i>Ø­Ø°Ù</button></div>
            </div>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div class="card p-6"><label class="block mb-2 font-semibold">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label><input type="text" id="start-date" class="input-field" value="${plan.startDate || ''}"></div>
                <div class="card p-6"><label class="block mb-2 font-semibold">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</label><input type="text" id="end-date" class="input-field" value="${plan.endDate || ''}"></div>
                <div class="card p-6"><label class="block mb-2 font-semibold">Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø¸Ø§Ù‡Ø± (ØªÙ…)</label><select id="public-theme-selector" class="input-field">${themeOptions}</select></div>
            </div>
            <div class="card p-6 mb-6">
                <div class="flex items-center gap-2 mb-4 border-b pb-4 overflow-x-auto"><div id="tabs-container" class="flex items-center gap-2">${tabsHtml}</div><button id="add-day-btn" class="btn btn-secondary flex-shrink-0 px-3 py-2 mr-auto"><i class="fas fa-plus"></i></button><button id="remove-day-btn" class="btn btn-danger flex-shrink-0 px-3 py-2"><i class="fas fa-trash"></i></button></div>
                <div id="days-content-container">${daysHtml}</div>
            </div>
            <div class="grid md:grid-cols-2 gap-6"><div class="card p-6"><label class="block mb-2 font-bold">Ù†Ú©Ø§Øª Ùˆ Ø¯Ø³ØªÙˆØ±â€ŒØ§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§</label><textarea id="instructions-area" class="input-field" rows="5">${(plan.instructions || []).join('\n')}</textarea></div><div class="card p-6"><label class="block mb-2 font-bold">Ù†Ú©Ø§Øª Ù…Ù‡Ù…</label><textarea id="important-notes-area" class="input-field" rows="5">${(plan.importantNotes || []).join('\n')}</textarea></div></div>`;
    }
    
    function loadAthleteEditor(id) {
        const athlete = athletes.find(a => a.id === id);
        if (athlete) { 
            currentAthleteId = id; 
            renderAthleteList(); 
            renderEditor(athlete); 
        }
    }

    function numberToPersianOrdinal(n) {
        const ordinals = ["Ø§ÙˆÙ„", "Ø¯ÙˆÙ…", "Ø³ÙˆÙ…", "Ú†Ù‡Ø§Ø±Ù…", "Ù¾Ù†Ø¬Ù…", "Ø´Ø´Ù…", "Ù‡ÙØªÙ…", "Ù‡Ø´ØªÙ…", "Ù†Ù‡Ù…", "Ø¯Ù‡Ù…"];
        if (n > 0 && n <= ordinals.length) return ordinals[n - 1];
        return n;
    }

    function setupAdminEventListeners() {
        document.body.addEventListener('click', e => {
            if (e.target.closest('#menu-toggle-btn')) {
                document.getElementById('sidebar')?.classList.add('sidebar-open');
                document.getElementById('sidebar-overlay')?.classList.remove('hidden');
            }
            if (e.target.closest('#sidebar-overlay')) {
                document.getElementById('sidebar')?.classList.remove('sidebar-open');
                document.getElementById('sidebar-overlay')?.classList.add('hidden');
            }
            if (e.target.closest('#add-athlete-btn')) {
                const name = prompt("Ù†Ø§Ù… Ø´Ø§Ú¯Ø±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
                if (name && name.trim()) addNewAthlete(name.trim());
            }
            if (e.target.closest('#logout-btn')) {
                signOut(auth).catch(err => console.error("Logout failed:", err));
            }
            if (e.target.closest('#settings-btn')) {
                document.getElementById('settings-modal').classList.remove('hidden');
                document.getElementById('admin-theme-selector').value = loadAdminTheme();
            }
            if (e.target.closest('#close-settings-modal-btn')) {
                document.getElementById('settings-modal').classList.add('hidden');
            }
        });

        const adminThemeSelector = document.getElementById('admin-theme-selector');
        if(adminThemeSelector) {
            adminThemeSelector.addEventListener('change', (e) => {
                applyTheme(e.target.value);
                saveAdminTheme(e.target.value);
            });
        }

        const mainContent = document.getElementById('main-content');
        if (mainContent) {
            mainContent.addEventListener('click', e => {
                if (e.target.closest('#save-all-btn')) { saveCurrentAthlete(true); return; }
                if (e.target.closest('#delete-athlete-btn')) { deleteCurrentAthlete(); return; }
                if (e.target.closest('#share-btn')) { shareCurrentAthlete(); return; }
                
                const dayTab = e.target.closest('.day-tab');
                if (dayTab) {
                    const dayIndex = parseInt(dayTab.dataset.day, 10);
                    const currentData = getEditorData();
                    if(currentData) renderEditor(currentData, dayIndex);
                    return;
                }

                if (handleDynamicEditorChanges(e)) return;
            });
        }
    }
    
    function handleDynamicEditorChanges(e) {
        const athleteIndex = athletes.findIndex(a => a.id === currentAthleteId);
        if (athleteIndex === -1) return false;

        const currentDOMState = getEditorData();
        if (!currentDOMState) return false;

        let athlete = currentDOMState;
        let modified = false;
        let activeDay = document.querySelector('.day-tab.active')?.dataset.day || 0;
        let newActiveIndex = parseInt(activeDay, 10);
        
        const addExerciseBtn = e.target.closest('.add-exercise-btn');
        if (addExerciseBtn) {
            const dayIndex = parseInt(addExerciseBtn.dataset.day, 10);
            if (athlete.plan.workoutDays?.[dayIndex]) {
                if (!athlete.plan.workoutDays[dayIndex].exercises) athlete.plan.workoutDays[dayIndex].exercises = [];
                athlete.plan.workoutDays[dayIndex].exercises.push({ name: '', sets: '', desc: '' });
                modified = true;
            }
        }

        const removeExerciseBtn = e.target.closest('.remove-exercise-btn');
        if (removeExerciseBtn) {
            const dayIndex = parseInt(removeExerciseBtn.dataset.day, 10);
            const exIndex = parseInt(removeExerciseBtn.dataset.ex, 10);
                if (athlete.plan.workoutDays?.[dayIndex]?.exercises) {
                athlete.plan.workoutDays[dayIndex].exercises.splice(exIndex, 1);
                modified = true;
            }
        }

        const addDayBtn = e.target.closest('#add-day-btn');
        if (addDayBtn) {
            if (!athlete.plan.workoutDays) athlete.plan.workoutDays = [];
            const newDayIndex = athlete.plan.workoutDays.length;
            athlete.plan.workoutDays.push({ day: `Ø±ÙˆØ² ${numberToPersianOrdinal(newDayIndex + 1)}`, exercises: [] });
            newActiveIndex = newDayIndex;
            modified = true;
        }
        
        const removeDayBtn = e.target.closest('#remove-day-btn');
        if (removeDayBtn) {
            const activeTab = document.querySelector('.day-tab.active');
            if (!activeTab) return true; // It's a handled click, even if no action
            showConfirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø±ÙˆØ² ØªÙ…Ø±ÛŒÙ†ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ", () => {
                const dayIndex = parseInt(activeTab.dataset.day, 10);
                const athleteStateAfterConfirm = getEditorData();
                if (athleteStateAfterConfirm.plan.workoutDays) {
                    athleteStateAfterConfirm.plan.workoutDays.splice(dayIndex, 1);
                    athleteStateAfterConfirm.plan.workoutDays.forEach((day, index) => { day.day = `Ø±ÙˆØ² ${numberToPersianOrdinal(index + 1)}`; });
                    athletes[athleteIndex] = athleteStateAfterConfirm;
                    const newActiveIndexAfterDelete = Math.max(0, dayIndex - 1);
                    renderEditor(athleteStateAfterConfirm, newActiveIndexAfterDelete);
                }
            });
            return true; // Stop further processing
        }
        
        if (modified) {
            athletes[athleteIndex] = athlete;
            renderEditor(athlete, newActiveIndex);
            return true;
        }
        return false;
    }
    
    function listenForAthletes() {
        if (!db) return;
        const athletesCollection = collection(db, "athletes");
        onSnapshot(query(athletesCollection), (querySnapshot) => {
            athletes = [];
            querySnapshot.forEach((doc) => athletes.push({ id: doc.id, ...doc.data() }));
            renderAthleteList();
            if(currentAthleteId) {
                const currentData = athletes.find(a => a.id === currentAthleteId);
                if(currentData) {
                    const activeDay = document.querySelector('.day-tab.active')?.dataset.day || 0;
                    renderEditor(currentData, parseInt(activeDay, 10));
                }
                else showWelcomeScreen();
            }
        }, (error) => { console.error("Error fetching athletes:", error); showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª."); });
    }

    async function addNewAthlete(name) {
        const newAthlete = { 
            name: name, 
            plan: { 
                trainerName: "Ø¨Ø§Ø±Ø§Ù† Ø­ÛŒØ¯Ø±ÛŒ", 
                trainerPhone: "09187231278", 
                startDate: "", endDate: "", 
                instructions: [], importantNotes: [],
                workoutDays: [{ day: "Ø±ÙˆØ² Ø§ÙˆÙ„", exercises: [] }], 
                theme: 'theme-default'
            } 
        };
        try {
            const docRef = await addDoc(collection(db, "athletes"), newAthlete);
            showToast(`Ø´Ø§Ú¯Ø±Ø¯ "${name}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`);
            loadAthleteEditor(docRef.id);
        } catch (e) { console.error("Error adding document: ", e); showToast("Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø´Ø§Ú¯Ø±Ø¯."); }
    }
    
    function getEditorData() {
        if (!currentAthleteId) return null;
        
        const editorScreen = document.getElementById('editor-screen');
        if (!editorScreen || editorScreen.classList.contains('hidden')) return null;

        const originalAthlete = athletes.find(a => a.id === currentAthleteId);
        if (!originalAthlete) return null;

        const updatedAthleteData = {
            id: currentAthleteId,
            name: document.getElementById('athlete-name-input').value,
            plan: {
                ...originalAthlete.plan,
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value,
                instructions: document.getElementById('instructions-area').value.split('\n').filter(line => line.trim() !== ''),
                importantNotes: document.getElementById('important-notes-area').value.split('\n').filter(line => line.trim() !== ''),
                theme: document.getElementById('public-theme-selector').value,
                workoutDays: []
            }
        };

        document.querySelectorAll('.day-content').forEach((dayContent, dayIndex) => {
            const dayTab = document.querySelector(`.day-tab[data-day="${dayIndex}"]`);
            const exercises = [];
            dayContent.querySelectorAll('.exercise-row').forEach((row) => {
                exercises.push({ 
                    name: row.querySelector(`input[data-field="name"]`).value, 
                    sets: row.querySelector(`input[data-field="sets"]`).value, 
                    desc: row.querySelector(`input[data-field="desc"]`).value 
                });
            });
            updatedAthleteData.plan.workoutDays.push({
                day: dayTab ? dayTab.textContent : `Ø±ÙˆØ² ${numberToPersianOrdinal(dayIndex + 1)}`, 
                exercises: exercises 
            });
        });

        return updatedAthleteData;
    }

    async function saveCurrentAthlete(showSuccessToast = false) {
        if (!currentAthleteId) return null;
        const saveBtn = document.getElementById('save-all-btn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ...';
        
        const updatedData = getEditorData();
        if(!updatedData) { 
            showToast("Ø®Ø·Ø§: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø§Ú¯Ø±Ø¯ ÛŒØ§ÙØª Ù†Ø´Ø¯."); 
            saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Ø°Ø®ÛŒØ±Ù‡'; 
            return; 
        }
        
        if (updatedData.plan.workoutDays) {
            updatedData.plan.workoutDays.forEach((day, index) => { day.day = `Ø±ÙˆØ² ${numberToPersianOrdinal(index + 1)}`; });
        }

        const { id, ...dataToSave } = updatedData;

        try {
            await setDoc(doc(db, "athletes", currentAthleteId), dataToSave);
            if (showSuccessToast) showToast(`Ø§Ø·Ù„Ø§Ø¹Ø§Øª ${updatedData.name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.`);
            return updatedData;
        } catch (e) { 
            console.error("Error updating document:", e); showToast("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª."); return null;
        } finally { 
            saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Ø°Ø®ÛŒØ±Ù‡'; 
        }
    }
    
    function deleteCurrentAthlete() {
        if (!currentAthleteId) return;
        const athleteName = athletes.find(a => a.id === currentAthleteId)?.name;
        showConfirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø´Ø§Ú¯Ø±Ø¯ "${athleteName}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`, async () => {
            try {
                await deleteDoc(doc(db, "athletes", currentAthleteId));
                showToast(`Ø´Ø§Ú¯Ø±Ø¯ "${athleteName}" Ø­Ø°Ù Ø´Ø¯.`);
                showWelcomeScreen();
            } catch (e) { console.error("Error deleting document:", e); showToast("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø´Ø§Ú¯Ø±Ø¯."); }
        });
    }

    function showWelcomeScreen(){
        const editorScreen = document.getElementById('editor-screen');
        const welcomeScreen = document.getElementById('welcome-screen');
        if (editorScreen) editorScreen.classList.add('hidden');
        if (welcomeScreen) welcomeScreen.classList.remove('hidden');
        currentAthleteId = null;
        renderAthleteList();
    }

    async function shareCurrentAthlete() {
        await saveCurrentAthlete(false);
        if (!currentAthleteId) {
             showToast("Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø´Ø§Ú¯Ø±Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
             return;
        }
        
        const shareLink = `${window.location.origin}${window.location.pathname}?id=${currentAthleteId}`;
        
        const modal = document.getElementById('share-modal');
        const linkInput = document.getElementById('share-link-input');
        linkInput.value = shareLink;
        modal.classList.remove('hidden');
        document.getElementById('copy-link-btn').onclick = () => { linkInput.select(); document.execCommand('copy'); showToast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯!');};
        document.getElementById('close-modal-btn').onclick = () => modal.classList.add('hidden');
    }

    async function main() {
        if (!auth) return;

        const urlParams = new URLSearchParams(window.location.search);
        const athleteId = urlParams.get('id');

        if (athleteId) {
            handlePublicView(athleteId);
        } else {
            applyTheme(loadAdminTheme());
            onAuthStateChanged(auth, (user) => {
                if (user && user.email === ADMIN_EMAIL) {
                    renderAdminPanel();
                } else {
                    if (user) { signOut(auth); }
                    renderLoginView();
                }
            });
        }
    }
    
    // Initialize the app
    main();

</script>
</body>
</html>
